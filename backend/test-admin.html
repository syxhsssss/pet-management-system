<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç®¡ç†åå°æµ‹è¯•é¡µé¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #FFB6C1; margin-bottom: 20px; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; background: #FFB6C1; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background: #FF69B4; }
        .result { padding: 15px; background: #f9f9f9; border-radius: 4px; margin-top: 10px; max-height: 400px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { padding: 15px; background: #fff5f7; border-radius: 6px; border-left: 3px solid #FFB6C1; }
        .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 8px; }
        .stat-card .value { font-size: 28px; color: #FFB6C1; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç®¡ç†åå°åŠŸèƒ½æµ‹è¯•</h1>

        <div class="section">
            <h2>ç¬¬ä¸€æ­¥ï¼šç™»å½•æµ‹è¯•</h2>
            <button class="btn" onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button class="btn" onclick="checkToken()">æ£€æŸ¥Token</button>
            <button class="btn" onclick="clearToken()">æ¸…é™¤Token</button>
            <div id="loginResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>ç¬¬äºŒæ­¥ï¼šæ•°æ®ç»Ÿè®¡</h2>
            <button class="btn" onclick="loadStats()">åŠ è½½ç»Ÿè®¡æ•°æ®</button>
            <div id="statsResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>ç¬¬ä¸‰æ­¥ï¼šç”¨æˆ·æ•°æ®</h2>
            <button class="btn" onclick="loadUsers()">åŠ è½½ç”¨æˆ·åˆ—è¡¨</button>
            <div id="usersResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>ç¬¬å››æ­¥ï¼šå•†å“æ•°æ®</h2>
            <button class="btn" onclick="loadProducts()">åŠ è½½å•†å“åˆ—è¡¨</button>
            <button class="btn" onclick="testUpdateProduct()">æµ‹è¯•ä¿®æ”¹å•†å“</button>
            <div id="productsResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>ç¬¬äº”æ­¥ï¼šæ”¶å…»æ•°æ®</h2>
            <button class="btn" onclick="loadAdoptions()">åŠ è½½æ”¶å…»åˆ—è¡¨</button>
            <div id="adoptionsResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>ç¬¬å…­æ­¥ï¼šå¸–å­æ•°æ®</h2>
            <button class="btn" onclick="loadPosts()">åŠ è½½å¸–å­åˆ—è¡¨</button>
            <div id="postsResult" class="result" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>å®Œæ•´æµ‹è¯•</h2>
            <button class="btn" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('adminToken');

        function showResult(elementId, html) {
            const elem = document.getElementById(elementId);
            elem.style.display = 'block';
            elem.innerHTML = html;
        }

        async function testLogin() {
            try {
                const res = await fetch('/admin/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin', password: 'admin123' })
                });
                const data = await res.json();

                if (data.success) {
                    token = data.data.token;
                    localStorage.setItem('adminToken', token);
                    showResult('loginResult', `
                        <p class="success">âœ… ç™»å½•æˆåŠŸï¼</p>
                        <p>ç”¨æˆ·: ${data.data.user.username}</p>
                        <p>è§’è‰²: ${data.data.user.role}</p>
                        <p>Token: ${token.substring(0, 50)}...</p>
                    `);
                } else {
                    showResult('loginResult', `<p class="error">âŒ ç™»å½•å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('loginResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        function checkToken() {
            if (token) {
                showResult('loginResult', `<p class="success">âœ… Tokenå­˜åœ¨: ${token.substring(0, 50)}...</p>`);
            } else {
                showResult('loginResult', `<p class="error">âŒ Tokenä¸å­˜åœ¨ï¼Œè¯·å…ˆç™»å½•</p>`);
            }
        }

        function clearToken() {
            localStorage.removeItem('adminToken');
            token = null;
            showResult('loginResult', `<p>ğŸ—‘ï¸ Tokenå·²æ¸…é™¤</p>`);
        }

        async function loadStats() {
            if (!token) {
                showResult('statsResult', '<p class="error">âŒ è¯·å…ˆç™»å½•è·å–Token</p>');
                return;
            }

            try {
                const res = await fetch('/admin/api/statistics', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.success) {
                    const s = data.data;
                    showResult('statsResult', `
                        <p class="success">âœ… ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸï¼</p>
                        <div class="stat-grid">
                            <div class="stat-card"><h3>æ€»ç”¨æˆ·æ•°</h3><div class="value">${s.users?.total_users || 0}</div></div>
                            <div class="stat-card"><h3>æ´»è·ƒç”¨æˆ·</h3><div class="value">${s.users?.active_users || 0}</div></div>
                            <div class="stat-card"><h3>å¸–å­æ€»æ•°</h3><div class="value">${s.posts?.total_posts || 0}</div></div>
                            <div class="stat-card"><h3>å¾…æ”¶å…»</h3><div class="value">${s.adoptions?.available_count || 0}</div></div>
                            <div class="stat-card"><h3>å•†å“æ€»æ•°</h3><div class="value">${s.products?.total_products || 0}</div></div>
                            <div class="stat-card"><h3>è®¢å•æ€»æ•°</h3><div class="value">${s.orders?.total_orders || 0}</div></div>
                        </div>
                        <pre>${JSON.stringify(data.data, null, 2)}</pre>
                    `);
                } else {
                    showResult('statsResult', `<p class="error">âŒ åŠ è½½å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('statsResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        async function loadUsers() {
            if (!token) {
                showResult('usersResult', '<p class="error">âŒ è¯·å…ˆç™»å½•è·å–Token</p>');
                return;
            }

            try {
                const res = await fetch('/admin/api/users', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.success) {
                    showResult('usersResult', `
                        <p class="success">âœ… æ‰¾åˆ° ${data.data.length} ä¸ªç”¨æˆ·</p>
                        <pre>${JSON.stringify(data.data.slice(0, 3), null, 2)}</pre>
                    `);
                } else {
                    showResult('usersResult', `<p class="error">âŒ åŠ è½½å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('usersResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        async function loadProducts() {
            if (!token) {
                showResult('productsResult', '<p class="error">âŒ è¯·å…ˆç™»å½•è·å–Token</p>');
                return;
            }

            try {
                const res = await fetch('/api/shop/products', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.success) {
                    const products = data.data.slice(0, 3);
                    showResult('productsResult', `
                        <p class="success">âœ… æ‰¾åˆ° ${data.data.length} ä¸ªå•†å“</p>
                        ${products.map(p => `
                            <div style="padding: 10px; margin: 10px 0; background: #f9f9f9; border-radius: 4px;">
                                <strong>${p.name}</strong> - Â¥${p.price}<br>
                                å›¾ç‰‡: ${p.images}<br>
                                <img src="${JSON.parse(p.images)[0]}" style="max-width: 200px; margin-top: 5px;" onerror="this.src='http://localhost:3001/images/dog1.jpg'">
                            </div>
                        `).join('')}
                    `);
                } else {
                    showResult('productsResult', `<p class="error">âŒ åŠ è½½å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('productsResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        async function testUpdateProduct() {
            if (!token) {
                showResult('productsResult', '<p class="error">âŒ è¯·å…ˆç™»å½•è·å–Token</p>');
                return;
            }

            try {
                // æµ‹è¯•æ›´æ–°ç¬¬ä¸€ä¸ªå•†å“çš„å›¾ç‰‡
                const res = await fetch('/admin/api/products/1', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'çš‡å®¶ç‹—ç²®æˆçŠ¬ç²® 10kg',
                        category: 'é£Ÿå“',
                        price: 199,
                        stock: 50,
                        description: 'é«˜å“è´¨ç‹—ç²®',
                        images: 'http://localhost:3001/images/dog1.jpg',
                        tags: 'ç‹—ç²®,è¥å…»'
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showResult('productsResult', `<p class="success">âœ… å•†å“æ›´æ–°æˆåŠŸï¼ç°åœ¨é‡æ–°åŠ è½½å•†å“åˆ—è¡¨æµ‹è¯•</p>`);
                    setTimeout(loadProducts, 1000);
                } else {
                    showResult('productsResult', `<p class="error">âŒ æ›´æ–°å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('productsResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        async function loadAdoptions() {
            if (!token) {
                showResult('adoptionsResult', '<p class="error">âŒ è¯·å…ˆç™»å½•è·å–Token</p>');
                return;
            }

            try {
                const res = await fetch('/admin/api/adoptions', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.success) {
                    const adoptions = data.data.slice(0, 3);
                    showResult('adoptionsResult', `
                        <p class="success">âœ… æ‰¾åˆ° ${data.data.length} ä¸ªå¾…æ”¶å…»å® ç‰©</p>
                        ${adoptions.map(a => `
                            <div style="padding: 10px; margin: 10px 0; background: #f9f9f9; border-radius: 4px;">
                                <strong>${a.name}</strong> - ${a.species} - ${a.location}<br>
                                å›¾ç‰‡: ${a.photos}<br>
                                <img src="${JSON.parse(a.photos)[0]}" style="max-width: 200px; margin-top: 5px;" onerror="this.src='http://localhost:3001/images/dog1.jpg'">
                            </div>
                        `).join('')}
                    `);
                } else {
                    showResult('adoptionsResult', `<p class="error">âŒ åŠ è½½å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('adoptionsResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        async function loadPosts() {
            if (!token) {
                showResult('postsResult', '<p class="error">âŒ è¯·å…ˆç™»å½•è·å–Token</p>');
                return;
            }

            try {
                const res = await fetch('/admin/api/posts', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();

                if (data.success) {
                    const posts = data.data.slice(0, 3);
                    showResult('postsResult', `
                        <p class="success">âœ… æ‰¾åˆ° ${data.data.length} ä¸ªå¸–å­</p>
                        ${posts.map(p => `
                            <div style="padding: 10px; margin: 10px 0; background: #f9f9f9; border-radius: 4px;">
                                <strong>${p.nickname}</strong>: ${p.content.substring(0, 50)}...<br>
                                å›¾ç‰‡: ${p.images}<br>
                                ${p.images && p.images !== '[]' ? `<img src="${JSON.parse(p.images)[0]}" style="max-width: 200px; margin-top: 5px;" onerror="this.src='http://localhost:3001/images/dog1.jpg'">` : ''}
                            </div>
                        `).join('')}
                    `);
                } else {
                    showResult('postsResult', `<p class="error">âŒ åŠ è½½å¤±è´¥: ${data.message}</p>`);
                }
            } catch (e) {
                showResult('postsResult', `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`);
            }
        }

        async function runAllTests() {
            await testLogin();
            await new Promise(r => setTimeout(r, 500));
            await loadStats();
            await new Promise(r => setTimeout(r, 500));
            await loadUsers();
            await new Promise(r => setTimeout(r, 500));
            await loadProducts();
            await new Promise(r => setTimeout(r, 500));
            await loadAdoptions();
            await new Promise(r => setTimeout(r, 500));
            await loadPosts();
            alert('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆï¼è¯·æŸ¥çœ‹å„é¡¹ç»“æœ');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥token
        window.onload = function() {
            if (token) {
                checkToken();
            }
        };
    </script>
</body>
</html>
