# 宠物管理系统 - 图片功能说明

## 📸 图片加载优化完成

所有图片已从国外的 Unsplash 服务器迁移到本地服务器，大幅提升加载速度！

---

## ✅ 已完成的改进

### 1. 本地图片服务
- ✅ 配置了静态文件服务：`http://localhost:3000/images/`
- ✅ 创建了本地图片存储目录：`backend/public/images/`
- ✅ 提供了占位符图片：dog1.jpg, dog2.jpg, dog3.jpg, cat1.jpg, cat2.jpg

### 2. 示例数据更新
- ✅ 修改了 `addSampleData.js` - 收养宠物数据使用本地图片
- ✅ 修改了 `createUsersAndPosts.js` - 社交帖子使用本地图片

### 3. 图片上传功能
- ✅ 实现了单文件上传接口：`POST /api/upload/single`
- ✅ 实现了多文件上传接口：`POST /api/upload/multiple`
- ✅ 支持的格式：jpg, jpeg, png, gif, webp
- ✅ 文件大小限制：5MB
- ✅ 自动生成唯一文件名，防止覆盖

### 4. 前端优化
- ✅ 添加了图片加载失败的兜底处理
- ✅ 使用本地占位符图片替代外部服务
- ✅ 优化了图片显示逻辑

---

## 🚀 使用说明

### 方法一：使用管理后台上传图片

1. 访问管理后台：`http://localhost:3000/admin`
2. 登录（默认账号：admin / admin123）
3. 在"收养管理"或"商品管理"中添加/编辑内容
4. 在图片URL字段输入本地图片路径，例如：
   - `http://localhost:3000/images/dog1.jpg`
   - `http://localhost:3000/images/cat1.jpg`

### 方法二：使用API上传图片

#### 上传单张图片
```javascript
// 前端代码示例
import { uploadAPI } from './services/api';

const handleUpload = async (file) => {
  try {
    const response = await uploadAPI.uploadSingle(file);
    if (response.data.success) {
      console.log('图片URL:', response.data.data.url);
      // 使用返回的URL保存到数据库
    }
  } catch (error) {
    console.error('上传失败', error);
  }
};
```

#### 上传多张图片
```javascript
const handleMultipleUpload = async (files) => {
  try {
    const response = await uploadAPI.uploadMultiple(files);
    if (response.data.success) {
      const urls = response.data.data.map(item => item.url);
      console.log('图片URLs:', urls);
    }
  } catch (error) {
    console.error('上传失败', error);
  }
};
```

### 方法三：手动添加图片

1. 将图片文件复制到 `backend/public/images/` 目录
2. 确保文件名符合规范（如：my-pet.jpg）
3. 在数据中使用完整URL：`http://localhost:3000/images/my-pet.jpg`

---

## 📂 文件结构

```
backend/
├── public/
│   └── images/           # 图片存储目录
│       ├── dog1.jpg      # 占位符图片
│       ├── dog2.jpg
│       ├── dog3.jpg
│       ├── cat1.jpg
│       ├── cat2.jpg
│       └── upload-*.jpg  # 上传的图片
├── server.js             # 配置了静态文件和上传功能
├── addSampleData.js      # 示例收养数据
└── createUsersAndPosts.js # 示例帖子数据
```

---

## 🔧 API接口文档

### 上传单张图片
- **接口**：`POST /api/upload/single`
- **参数**：FormData，字段名为 `image`
- **返回**：
```json
{
  "success": true,
  "message": "上传成功",
  "data": {
    "url": "http://localhost:3000/images/upload-1234567890-abc.jpg",
    "filename": "upload-1234567890-abc.jpg",
    "size": 102400
  }
}
```

### 上传多张图片
- **接口**：`POST /api/upload/multiple`
- **参数**：FormData，字段名为 `images`（可多个文件）
- **限制**：最多10张
- **返回**：
```json
{
  "success": true,
  "message": "上传成功",
  "data": [
    {
      "url": "http://localhost:3000/images/upload-xxx.jpg",
      "filename": "upload-xxx.jpg",
      "size": 102400
    }
  ]
}
```

---

## ⚙️ 配置说明

### 文件大小限制
在 `server.js` 中可以修改：
```javascript
const upload = multer({
  storage: storage,
  limits: { fileSize: 5 * 1024 * 1024 }, // 修改这里，单位为字节
  fileFilter: fileFilter
});
```

### 支持的文件格式
在 `server.js` 中可以修改：
```javascript
const fileFilter = (req, file, cb) => {
  const allowedTypes = /jpeg|jpg|png|gif|webp/; // 在这里添加更多格式
  // ...
};
```

---

## 🎯 下一步建议

1. **添加图片压缩**：在上传时自动压缩图片以节省空间
2. **使用CDN**：将图片部署到七牛云/阿里云OSS等服务
3. **图片管理功能**：在管理后台添加图片浏览和删除功能
4. **图片裁剪**：添加在线裁剪功能

---

## ❓ 常见问题

### Q: 为什么图片还是加载慢？
A: 请确保：
1. 后端服务器已启动（`http://localhost:3000`）
2. 使用的是本地图片URL（以 `http://localhost:3000/images/` 开头）
3. 图片文件确实存在于 `backend/public/images/` 目录中

### Q: 如何批量替换现有数据的图片？
A: 可以执行以下SQL更新数据库中的图片链接：
```sql
-- 示例：更新收养表的图片
UPDATE adoptions
SET photos = REPLACE(photos, 'https://images.unsplash.com/', 'http://localhost:3000/images/');
```

### Q: 上传的图片存储在哪里？
A: 所有上传的图片存储在 `backend/public/images/` 目录，文件名格式为 `upload-时间戳-随机数.扩展名`

---

## 📞 技术支持

如有问题，请检查：
1. 后端控制台是否有错误信息
2. 浏览器开发者工具的Network标签查看图片请求状态
3. 确认文件权限是否正确

祝使用愉快！🎉
